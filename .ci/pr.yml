---
resource_types:
- name: pull-request
  type: docker-image
  source:
    repository: teliaoss/github-pr-resource

resources:
- name: pull-request
  type: pull-request
  check_every: 24h
  webhook_token: ((webhook_token))
  source:
    repository: magnonellie/amethyst
    access_token: ((repo_github_token))

jobs:
- name: linux-rust-stable
  max_in_flight: 1
  public: true
  interruptible: true
  plan:
  - get: amethyst
    resource: pull-request
    trigger: true
    version: every
  - put: pull-request
    params: { path: amethyst, status: pending, context: linux }
  - task: tests
    input_mapping: { amethyst: pull-request }
    file: amethyst/.ci/tasks/linux-test.yml
  - task: book
    input_mapping: { amethyst: pull-request }
    file: amethyst/.ci/tasks/linux-book.yml
  - put: pull-request
    params: { path: amethyst, status: success, context: linux }
  on_failure:
    put: pull-request
    params: { path: amethyst, status: failure, context: linux }

- name: windows-rust-stable
  max_in_flight: 1
  public: true
  interruptible: true
  plan:
  - get: amethyst
    resource: pull-request
    trigger: true
    version: every
  - put: pull-request
    params: { path: amethyst, status: pending, context: windows }
  - task: tests
    input_mapping: { amethyst: pull-request }
    file: amethyst/.ci/tasks/windows-test.yml
  - put: pull-request
    params: { path: amethyst, status: success, context: windows }
  on_failure:
    put: pull-request
    params: { path: amethyst, status: failure, context: windows }

- name: linux-rustfmt
  public: true
  plan:
  - get: amethyst
    resource: pull-request
    trigger: true
    version: every
  - task: check
    file: amethyst/.ci/tasks/linux-rustfmt.yml
    # TODO: send a helpful message to the PR if this fails
